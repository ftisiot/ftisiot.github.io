<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>11 Lessons to learn when using NULLs in PostgreSQL® | Data and Open Source</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="11 Lessons to learn when using NULLs in PostgreSQL®">
    <meta name="generator" content="Hugo 0.140.2">
    
    
    
      <meta name="robots" content="index, follow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    


    
      

    

    

    
      <link rel="canonical" href="https://ftisiot.net/posts/postgresql-isnull/">
    

    <meta property="og:url" content="https://ftisiot.net/posts/postgresql-isnull/">
  <meta property="og:site_name" content="Data and Open Source">
  <meta property="og:title" content="11 Lessons to learn when using NULLs in PostgreSQL®">
  <meta property="og:description" content="11 Lessons to learn when using NULLs in PostgreSQL®">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-28T08:00:29+01:00">
    <meta property="article:modified_time" content="2024-02-28T08:00:29+01:00">

  <meta itemprop="name" content="11 Lessons to learn when using NULLs in PostgreSQL®">
  <meta itemprop="description" content="11 Lessons to learn when using NULLs in PostgreSQL®">
  <meta itemprop="datePublished" content="2024-02-28T08:00:29+01:00">
  <meta itemprop="dateModified" content="2024-02-28T08:00:29+01:00">
  <meta itemprop="wordCount" content="3160">
  <meta itemprop="keywords" content="PostgreSQL,SQL,Isnull,Coalesce">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="11 Lessons to learn when using NULLs in PostgreSQL®">
  <meta name="twitter:description" content="11 Lessons to learn when using NULLs in PostgreSQL®">

      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7Z74BTZ0TM"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7Z74BTZ0TM');
        }
      </script>
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  
  
  
  <header class="cover bg-center" style="background-image: url('https://ftisiot.net/images/2024/isnull.png');">
    <div class="bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Data and Open Source
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/who" title="about page">
              about
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/suggestions-verona" title="suggestions page">
              suggestions
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/postgresqljson/main" title="json-pg page">
              json-pg
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/mysqljson/main" title="json-mysql page">
              json-mysql
            </a>
          </li>
          
        </ul>
      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <div class="f2 f1-l fw2 white-90 mb0 lh-title">11 Lessons to learn when using NULLs in PostgreSQL®</div>
          
            <div class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">
              11 Lessons to learn when using NULLs in PostgreSQL®
            </div>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">11 Lessons to learn when using NULLs in PostgreSQL®</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2024-02-28T08:00:29+01:00">February 28, 2024</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 15 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 3160 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>A boolean value should only contain two values, <code>True</code> or <code>False</code>, but is it correct? Usually people assume so, but sometimes miss the fact that there could be the <strong>absence</strong> of the value all-together. In databases this is absence is usually stored as <code>NULL</code> and this blog showcases how to find them, use them properly and 11 lessons to learn to be a <code>NULL</code> Pro!</p>
<blockquote>
<p>Keep in mind, it&rsquo;s not only booleans that can contain <code>NULL</code> values, it&rsquo;s all the columns where you don&rsquo;t define a <code>NOT NULL</code> constraint!</p>
</blockquote>
<h2 id="it-all-starts-with-some-columns-and-rows">It all starts with some columns and rows</h2>
<p>Let&rsquo;s start from the basics: you have a PostgreSQL® database and a table, called <code>users</code> like:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>id<span style="color:#bbb"> </span><span style="color:#008000">SERIAL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>username<span style="color:#bbb"> </span><span style="color:#008000">TEXT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">KEY</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>name<span style="color:#bbb"> </span><span style="color:#008000">TEXT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>surname<span style="color:#bbb"> </span><span style="color:#008000">TEXT</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>age<span style="color:#bbb"> </span><span style="color:#008000">INT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>);<span style="color:#bbb">
</span></span></span></code></pre></div><blockquote>
<p>Hey, do you want to test the above code but not having a PostgreSQL database handy? Past your code in <a href="https://pgplayground.com/?utm_medium=organic&amp;utm_source=ext_blog&amp;utm_content=ftisiotNULL">PostgreSQL Playground</a> and quickly check the results!</p>
</blockquote>
<p>Let&rsquo;s insert some data:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>surname,<span style="color:#bbb"> </span>age)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;jdoe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Jon&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Doe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#666">25</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;lspencer&#39;</span>,<span style="color:#ba2121">&#39;Liz&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Spencer&#39;</span>,<span style="color:#bbb"> </span><span style="color:#666">35</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;hlondon&#39;</span>,<span style="color:#ba2121">&#39;Hanna&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;London&#39;</span>,<span style="color:#bbb"> </span><span style="color:#666">45</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Querying the data showcases the table with all the columns filled.</p>
<pre tabindex="0"><code> id | username | name  | surname | age 
----+----------+-------+---------+-----
  1 | jdoe     | Jon   | Doe     |  25
  2 | lspencer | Liz   | Spencer |  35
  3 | hlondon  | Hanna | London  |  45
(3 rows)
</code></pre><h2 id="insert-nulls">Insert NULLs</h2>
<p>Now, let&rsquo;s check if we can insert some <code>NULL</code>s, let&rsquo;s try by inserting them in the <code>name</code>, <code>surname</code> and <code>age</code> columns:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>name,<span style="color:#bbb"> </span>surname,<span style="color:#bbb"> </span>age)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;test&#39;</span>,<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>This works since we don&rsquo;t have any constraint</p>
<pre tabindex="0"><code> id | username | name  | surname | age 
----+----------+-------+---------+-----
  1 | jdoe     | Jon   | Doe     |  25
  2 | lspencer | Liz   | Spencer |  35
  3 | hlondon  | Hanna | London  |  45
  4 | test     |       |         |    
(4 rows)
</code></pre><p>We can even simplify the insert with the same effect</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;test1&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Result:</p>
<pre tabindex="0"><code> id | username | name  | surname | age 
----+----------+-------+---------+-----
  1 | jdoe     | Jon   | Doe     |  25
  2 | lspencer | Liz   | Spencer |  35
  3 | hlondon  | Hanna | London  |  45
  4 | test     |       |         |    
  5 | test1    |       |         |    
(5 rows)
</code></pre><h2 id="inserting-nulls">Inserting NULLs</h2>
<p>The first step to avoid <code>NULL</code>s from appearing in a table is to forbid inserting them. The section below showcases a few situations on how to avoid inserting <code>NULL</code>s in new and existing columns.</p>
<h3 id="inserting-nulls-in-the-primary-key">Inserting NULLs in the primary key</h3>
<p>Can I insert a <code>NULL</code> in the table primary key? In theory this could be allowed since there&rsquo;s no explicit <code>NOT NULL</code> constraint on the column. Let&rsquo;s try:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>However this fails with:</p>
<pre tabindex="0"><code>ERROR:  null value in column &#34;username&#34; of relation &#34;users&#34; violates not-null constraint
DETAIL:  Failing row contains (6, null, null, null, null).
</code></pre><p><strong>💡 Lesson 1 💡</strong>: Primary Keys are by default <code>NOT NULL</code></p>
<h3 id="create-a-new-column-with-not-null-constraint">Create a new column with NOT NULL constraint</h3>
<p>Let&rsquo;s add a new column to our table:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>points<span style="color:#bbb"> </span><span style="color:#008000">INT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>This will fail, since the previously inserted data don&rsquo;t have any associated value for <code>points</code></p>
<pre tabindex="0"><code>ERROR:  column &#34;points&#34; of relation &#34;users&#34; contains null values
</code></pre><p>Let&rsquo;s add a default value with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>points<span style="color:#bbb"> </span><span style="color:#008000">INT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#666">0</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The table was altered, and now contains <code>0 points</code> for all the existing rows.</p>
<pre tabindex="0"><code> id | username | name  | surname | age | points 
----+----------+-------+---------+-----+--------
  1 | jdoe     | Jon   | Doe     |  25 |      0
  2 | lspencer | Liz   | Spencer |  35 |      0
  3 | hlondon  | Hanna | London  |  45 |      0
  4 | test     |       |         |     |      0
  5 | test1    |       |         |     |      0
(5 rows)
</code></pre><p>If we try to insert a new row without specifying the <code>points</code> column:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;usrwithnullpoints&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>The row is inserted with the default <code>0 points</code></p>
<pre tabindex="0"><code> id |     username      | name  | surname | age | points 
----+-------------------+-------+---------+-----+--------
  1 | jdoe              | Jon   | Doe     |  25 |      0
  2 | lspencer          | Liz   | Spencer |  35 |      0
  3 | hlondon           | Hanna | London  |  45 |      0
  4 | test              |       |         |     |      0
  5 | test1             |       |         |     |      0
  7 | usrwithnullpoints |       |         |     |      0
(6 rows)
</code></pre><p>What if we try to push a <code>NULL</code> into <code>points</code>?</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>points)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;forcenullpoints&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>We get the <code>ERROR:  null value in column &quot;points&quot; of relation &quot;users&quot; violates not-null constraint</code> stating that our insert is violating the <code>NOT NULL</code> constraint.</p>
<p><strong>💡 Lesson 2 💡</strong>: Setting a <code>NOT NULL</code> constraint doesn&rsquo;t allow inserting <code>NULL</code>s</p>
<p><strong>💡 Lesson 3 💡</strong>: If we want to add a <code>NOT NULL</code> column to an existing table with data, we need to specify the <strong>default</strong> value for existing rows.</p>
<h3 id="add-a-not-null-constraint-to-an-existing-column">Add a NOT NULL constraint to an existing column</h3>
<p>If we try to change an existing column (e.g. <code>name</code>) to add the <code>NOT NULL</code> constraint:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>We get the similar error <code>ERROR:  column &quot;name&quot; of relation &quot;users&quot; contains null values</code>, therefore we need also need to amend the current <code>NULL</code> values (and possibly set a default)</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TYPE</span><span style="color:#bbb"> </span><span style="color:#008000">TEXT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">USING</span><span style="color:#bbb"> </span>(COALESCE(name,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Hugo&#39;</span>)),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Hugo&#39;</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>In the above we:</p>
<ul>
<li>Altered the type, setting it to <code>TEXT</code> again, to apply the function <code>COALESCE(name, 'Hugo')</code> which is replacing <code>NULL</code>s in the <code>name</code> field with <code>Hugo</code></li>
<li>Set the default value for the <code>name</code> column to <code>Hugo</code> &lt;- This is not strictly necessary</li>
<li>Applied the <code>NOT NULL</code> constraint since we don&rsquo;t have any <code>NULL</code> values anymore</li>
</ul>
<blockquote>
<p>Note: the above method locks the entire table until done. A faster approach could be to split the <code>COALESCE(name, 'Hugo')</code> into a dedicated update and then only perform the <code>NOT NULL</code> and <code>DEFAULT</code> settings on the <code>ALTER TABLE</code> statement.</p>
</blockquote>
<p>The results are in line with the expected, no <code>NULL</code>s in the <code>name</code> column, being replaced by <code>Hugo</code></p>
<pre tabindex="0"><code> id |     username      | name  | surname | age | points 
----+-------------------+-------+---------+-----+--------
  1 | jdoe              | Jon   | Doe     |  25 |      0
  2 | lspencer          | Liz   | Spencer |  35 |      0
  3 | hlondon           | Hanna | London  |  45 |      0
  4 | test              | Hugo  |         |     |      0
  5 | test1             | Hugo  |         |     |      0
  7 | usrwithnullpoints | Hugo  |         |     |      0
(6 rows)
</code></pre><p><strong>💡 Lesson 4 💡</strong>: If we need to add a <code>NOT NULL</code> column to an existing column in a table, we need to amend the existing <code>NULL</code> values and optionally set the <strong>default</strong> value for incoming rows.</p>
<p>What if I want to <strong>remove</strong> the <code>NOT NULL</code> constraint? We can do it with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DROP</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>;<span style="color:#bbb">
</span></span></span></code></pre></div><h3 id="is-default-enough">Is DEFAULT enough?</h3>
<p>What if we leave the <code>NOT NULL</code> constraint aside, and just set the <code>DEFAULT</code>? Let&rsquo;s try with the <code>date_first_login</code> new column</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">COLUMN</span><span style="color:#bbb"> </span>date_first_login<span style="color:#bbb"> </span><span style="color:#008000">DATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">DEFAULT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_DATE</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Checking what&rsquo;s in the table, we see all the <code>date_first_login</code> filled</p>
<pre tabindex="0"><code> id |     username      | name  | surname | age | points | date_first_login 
----+-------------------+-------+---------+-----+--------+------------------
  1 | jdoe              | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer          | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon           | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test              | Hugo  |         |     |      0 | 2024-02-27
  5 | test1             | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints | Hugo  |         |     |      0 | 2024-02-27
(6 rows)
</code></pre><p>If we try to insert a new row, without specifying the <code>date_first_login</code>, it&rsquo;s correctly assigned to today</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;user_with_no_date_first_login&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>The above is correctly inserted with a not null <code>date_first_login</code></p>
<pre tabindex="0"><code> id |           username            | name  | surname | age | points | date_first_login 
----+-------------------------------+-------+---------+-----+--------+------------------
  1 | jdoe                          | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer                      | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon                       | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                          | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                         | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints             | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login | Hugo  |         |     |      0 | 2024-02-27
(7 rows)
</code></pre><p>So&hellip; is the <code>NOT NULL</code> constraint really needed? The reply is <strong>YES</strong> since I could insert <code>NULLs</code> by specifying it in the <code>INSERT</code> statement</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span>(username,<span style="color:#bbb"> </span>date_first_login)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;user_with_null_date_first_login&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Which will be stored correctly with a <code>NULL</code> value for <code>date_first_login</code></p>
<pre tabindex="0"><code> id |            username             | name  | surname | age | points | date_first_login 
----+---------------------------------+-------+---------+-----+--------+------------------
  1 | jdoe                            | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer                        | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon                         | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                            | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo  |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo  |         |     |      0 | 
(8 rows)
</code></pre><p><strong>💡 Lesson 5 💡</strong>: The <code>DEFAULT</code> is going to prevent <code>NULL</code>s from being inserted only if the <code>NULL</code> is <strong>NOT</strong> specified in the target column. To enforce the value we need an explicit <code>NOT NULL</code> constraint</p>
<h2 id="querying-nulls">Querying NULLs</h2>
<p>In the above section we tried to avoid storing <code>NULL</code>s in our systems, what if we need to deal with existing <code>NULL</code>s in our column? Here we can use a few SQL functions to detect them and change their value.</p>
<h3 id="detecting-nulls-with-the-is-null-condition">Detecting NULLs with the <code>IS NULL</code> condition</h3>
<p>What if we want to detect the <code>NULL</code> values? We can use the <code>IS NULL</code> condition, for example:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Which will retrieve the list of <code>NULL</code>s surnames</p>
<pre tabindex="0"><code> id |            username             | name | surname | age | points | date_first_login 
----+---------------------------------+------+---------+-----+--------+------------------
  4 | test                            | Hugo |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo |         |     |      0 | 
(5 rows)
</code></pre><p>The opposite list could be retrieved by applying the <code>IS NOT NULL</code> condition:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Resulting in</p>
<pre tabindex="0"><code> id | username | name  | surname | age | points | date_first_login 
----+----------+-------+---------+-----+--------+------------------
  1 | jdoe     | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon  | Hanna | London  |  45 |      0 | 2024-02-27
(3 rows)
</code></pre><p>What if I try to use the equal comparison (<code>=</code>)</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The above retrieves <strong>NO rows</strong> since the <code>NULL</code> value means there is <strong>NO value</strong> and is <strong>NOT</strong> equal to any other value (<code>NULL</code>=<code>NULL</code> is <strong>False</strong>)</p>
<pre tabindex="0"><code> id | username | name | surname | age | points | date_first_login 
----+----------+------+---------+-----+--------+------------------
(0 rows)
</code></pre><p>If we apply the different operator (<code>&lt;&gt;</code>) with <code>NULL</code> we also get back <strong>NO rows</strong>, since the <code>NULL</code> value means there is <strong>NO value</strong>, and therefore is not equal or different to other values.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#666">&lt;&gt;</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p><strong>💡 Lesson 6 💡</strong>: To find <code>NULL</code>s we should always use the <code>IS NULL</code>; the <code>IS NOT NULL</code> to fetch the not null rows.</p>
<h3 id="associating-a-default-value-to-nulls-with-coalesce">Associating a default value to NULLs with COALESCE</h3>
<p>In the above we saw how to find <code>NULL</code>s, what if we need to include them in a <code>SELECT</code> statement with other values? We can either add an <code>OR</code> condition like</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;London&#39;</span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">OR</span><span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">IS</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">NULL</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Or we can apply a transformation to change the <code>NULL</code>s into a value we can compare</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>COALESCE(surname,<span style="color:#ba2121">&#39;Verona&#39;</span>)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">in</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#39;London&#39;</span>,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;Verona&#39;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Both will have the same result</p>
<pre tabindex="0"><code> id |            username             | name  | surname | age | points | date_first_login 
----+---------------------------------+-------+---------+-----+--------+------------------
  3 | hlondon                         | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                            | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo  |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo  |         |     |      0 | 
(6 rows)
</code></pre><p>However, if we apply the second option, we must be sure that <code>Verona</code> (the label we associate to <code>NULL</code> values) is a value not present in the column or a value we want to include in our selection.</p>
<p><strong>💡 Lesson 7 💡</strong>: When using <code>COALESCE</code> check out that the value you want to use as substitute of <code>NULL</code> is not already present in the table and outside of your business logic otherwise you might include in the filter more values than expected.</p>
<h3 id="performing-math-on-null-columns">Performing Math on NULL columns</h3>
<p>A similar scenario is due when we need to perform a calculation over a <code>NULL</code>able column. Let&rsquo;s take the example of the <code>age</code> column: what if we want to calculate the average age?</p>
<p>Let&rsquo;s see the data:</p>
<pre tabindex="0"><code> id |            username             | name  | surname | age | points | date_first_login 
----+---------------------------------+-------+---------+-----+--------+------------------
  1 | jdoe                            | Jon   | Doe     |  25 |      0 | 2024-02-27
  2 | lspencer                        | Liz   | Spencer |  35 |      0 | 2024-02-27
  3 | hlondon                         | Hanna | London  |  45 |      0 | 2024-02-27
  4 | test                            | Hugo  |         |     |      0 | 2024-02-27
  5 | test1                           | Hugo  |         |     |      0 | 2024-02-27
  7 | usrwithnullpoints               | Hugo  |         |     |      0 | 2024-02-27
  9 | user_with_no_date_first_login   | Hugo  |         |     |      0 | 2024-02-27
 10 | user_with_null_date_first_login | Hugo  |         |     |      0 | 
(8 rows)
</code></pre><p>We can calculate the average age with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">avg</span>(age)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Resulting in <code>35</code> which is the average between the 3 <strong>NOT NULL</strong> ages! Similarly if we count the <code>date_first_login</code>s with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">count</span>(date_first_login)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The result is <code>7</code>, one row for every user having a not null <code>date_first_login</code></p>
<p><strong>💡 Lesson 8 💡</strong>: When performing Mathematical operation with nullable columns, only <strong>NOT NULL</strong> values will be elaborated!</p>
<p>What if we try to calculate the average <code>points</code>? First let&rsquo;s update the table to give <code>jdoe</code> 25 points</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">UPDATE</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">set</span><span style="color:#bbb"> </span>points<span style="color:#666">=</span><span style="color:#666">25</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>username<span style="color:#666">=</span><span style="color:#ba2121">&#39;jdoe&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Now let&rsquo;s calcuate the average points</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">avg</span>(points)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>users;<span style="color:#bbb">
</span></span></span></code></pre></div><p>The result is <code>3.125</code> which is the mathematical average between the <code>25</code> points of <code>jdoe</code> and the <code>0</code> of the rest due to us previously setting <code>0</code> as default value. Is this correct? It depends! If we wanted to calculate the average number of points of users actually playing some games, this could be a misleading calculation.</p>
<p><strong>💡 Lesson 9 💡</strong>: When performing Mathematical operation with nullable columns, the default value of a column will impact the results.</p>
<h3 id="joining-on-null-columns">Joining on NULL columns</h3>
<p>Building on what we explored before about the <code>NULL</code> not being equal or different to any other value, we need to pay closer attention when we deal with nullable columns in join condition.</p>
<p>Let&rsquo;s create another table called <code>sessions</code> and insert some data. For a weird reason, the design of this table will force us to join with <code>users</code> on the <code>surname</code> which is a NULLABLE field.</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span>(id<span style="color:#bbb"> </span><span style="color:#008000">serial</span>,<span style="color:#bbb"> </span>surname<span style="color:#bbb"> </span><span style="color:#008000">text</span>,<span style="color:#bbb"> </span>session_time<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">timestamp</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span>(surname,<span style="color:#bbb"> </span>session_time)<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">values</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Doe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Doe&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Spencer&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#ba2121">&#39;Spencer&#39;</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">2</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span><span style="color:#bbb"> </span><span style="color:#666">-</span><span style="color:#bbb"> </span><span style="color:#008000">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#39;1 day&#39;</span><span style="color:#666">*</span><span style="color:#666">1</span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>(<span style="color:#008000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">CURRENT_TIMESTAMP</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>Now, if we want to count users having a session on each day we could think of simply writing the above query:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">count</span>(<span style="color:#008000;font-weight:bold">distinct</span><span style="color:#bbb"> </span>username)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">join</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">on</span><span style="color:#bbb"> </span>sessions.surname<span style="color:#666">=</span>users.surname<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">group</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">by</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time);<span style="color:#bbb">
</span></span></span></code></pre></div><p>However the results shows only the 4 sessions below</p>
<pre tabindex="0"><code> extract | count 
---------+-------
      25 |     2
      26 |     1
      27 |     1
(3 rows)
</code></pre><p>Why? It&rsquo;s again because of <code>NULL</code> values in the join condition. This problem of poor data quality on both ends of the join is stopping us from reporting any useful number. How could we fix it? Well, the fix should be done uphill by setting the <code>sessions</code> table to use the <code>username</code> instead of the <code>surname</code> and defining a proper <code>FOREIGN KEY</code> to the <code>users</code> table.</p>
<p><strong>💡 Lesson 10 💡</strong>: Joining tables on nullable columns without caring about the NULL management will impact the results by reducing the number of rows included in the join.</p>
<p>Still, if we want a simplistic solution, we could do the apply the <code>COALESCE</code> to both sides of the join:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">count</span>(<span style="color:#008000;font-weight:bold">distinct</span><span style="color:#bbb"> </span>username)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">join</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">on</span><span style="color:#bbb"> </span>coalesce(sessions.surname,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;NoSurname&#39;</span>)<span style="color:#666">=</span>coalesce(users.surname,<span style="color:#bbb"> </span><span style="color:#ba2121">&#39;NoSurname&#39;</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">group</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">by</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time);<span style="color:#bbb">
</span></span></span></code></pre></div><p>The result shows an increased count of sessions</p>
<pre tabindex="0"><code> extract | count 
---------+-------
      25 |     7
      26 |     6
      27 |     6
(3 rows)
</code></pre><p>However this is still not the correct answer, since we are seeing <code>19</code> session being aggregated while only <code>9</code> sessions were inserted in the original <code>sessions</code> table. Why is that? It&rsquo;s because we now casted all the <code>NULL</code>s as <code>NoSurname</code> on both sides of the join. Since we had <code>5</code> sessions without <code>surname</code> and <code>5</code> users without <code>surname</code> we are creating a cartesian join of all the empty surnames with the empty sessions.</p>
<p>We had the following users without <code>surname</code></p>
<pre tabindex="0"><code>test
test1
usrwithnullpoints
user_with_no_date_first_login
user_with_null_date_first_login
</code></pre><p>And the following sessions without <code>surname</code></p>
<pre tabindex="0"><code>  6 | 2024-02-27 14:10:08.419021
  7 | 2024-02-25 14:10:08.419021
  8 | 2024-02-25 14:10:08.419021
  9 | 2024-02-26 14:10:08.419021
 10 | 2024-02-27 14:10:08.419021
</code></pre><p>Each of the users was associated with each sessions, creating a overflow of sessions.</p>
<p>A more correct solution, attribuiting all the <code>NULL</code> session to a same phantom user <code>NoUser</code> could be:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">count</span>(<span style="color:#008000;font-weight:bold">distinct</span><span style="color:#bbb"> </span>coalesce(username,<span style="color:#ba2121">&#39;NoUser&#39;</span>))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>sessions<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">left</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">outer</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">join</span><span style="color:#bbb"> </span>users<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#008000;font-weight:bold">on</span><span style="color:#bbb"> </span>sessions.surname<span style="color:#666">=</span>users.surname<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">group</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">by</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">EXTRACT</span>(<span style="color:#008000;font-weight:bold">DAY</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>session_time);<span style="color:#bbb">
</span></span></span></code></pre></div><p>However this is an effort to fix data quality issues at query time, which is never a good idea.</p>
<p><strong>💡 Lesson 11 💡</strong>: Fixing data quality issues related to nullable columns at query time is a risky approach. Solving them with proper table design and constraints allows you to keep quality data in the tables.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Dealing with <code>NULL</code>s is something to care upfront, during table design, in order to avoid data quality issues downstream!
This is it for the 11 lessons learnt using <code>NULL</code>s, do you have others to share? Feel free to reach me on X/Twitter at @ftisiot or on <a href="https://www.linkedin.com/in/francescotisiot/">Linkedin</a></p><ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://ftisiot.net/" >
    &copy;  Data and Open Source 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>

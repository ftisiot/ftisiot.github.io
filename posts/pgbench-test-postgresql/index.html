<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>How to use pgbench to test PostgreSQL® performance | ftisiot ideas about tech, food and life</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="How to use pgbench to test PostgreSQL® performance">
    <meta name="generator" content="Hugo 0.140.2">
    
    
    
      <meta name="robots" content="index, follow">
    
    

    
<link rel="stylesheet" href="/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    


    
      

    

    

    
      <link rel="canonical" href="https://ftisiot.net/posts/pgbench-test-postgresql/">
    

    <meta property="og:url" content="https://ftisiot.net/posts/pgbench-test-postgresql/">
  <meta property="og:site_name" content="ftisiot ideas about tech, food and life">
  <meta property="og:title" content="How to use pgbench to test PostgreSQL® performance">
  <meta property="og:description" content="How to use pgbench to test PostgreSQL® performance">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-11T11:10:09+01:00">
    <meta property="article:modified_time" content="2024-03-11T11:10:09+01:00">

  <meta itemprop="name" content="How to use pgbench to test PostgreSQL® performance">
  <meta itemprop="description" content="How to use pgbench to test PostgreSQL® performance">
  <meta itemprop="datePublished" content="2024-03-11T11:10:09+01:00">
  <meta itemprop="dateModified" content="2024-03-11T11:10:09+01:00">
  <meta itemprop="wordCount" content="1031">
  <meta itemprop="keywords" content="PostgreSQL,Pgbench,Performance">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="How to use pgbench to test PostgreSQL® performance">
  <meta name="twitter:description" content="How to use pgbench to test PostgreSQL® performance">

      
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7Z74BTZ0TM"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-7Z74BTZ0TM');
        }
      </script>
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  
  
  
  <header class="cover bg-center" style="background-image: url('https://ftisiot.net/images/2024/index_suggestion.png');">
    <div class="bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        ftisiot ideas about tech, food and life
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/who" title="about page">
              about
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/suggestions-verona" title="suggestions page">
              suggestions
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/postgresqljson/main" title="json-pg page">
              json-pg
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/mysqljson/main" title="json-mysql page">
              json-mysql
            </a>
          </li>
          
        </ul>
      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <div class="f2 f1-l fw2 white-90 mb0 lh-title">How to use pgbench to test PostgreSQL® performance</div>
          
            <div class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">
              How to use pgbench to test PostgreSQL® performance
            </div>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">How to use pgbench to test PostgreSQL® performance</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2024-03-11T11:10:09+01:00">March 11, 2024</time>
      

      
      
        <span class="f6 mv4 dib tracked"> - 5 minutes read </span>
        <span class="f6 mv4 dib tracked"> - 1031 words </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Testing a database performance is a must in every company. Despite everyone&rsquo;s needs beings slightly different, a good starting point for PostgreSQL® database is using <a href="https://www.postgresql.org/docs/current/pgbench.html">pgbench</a>: a tool shipped with the PostgreSQL installation that allows you to stress test a local or remote database.
This blog post showcases how to install (on a Mac) and use pgbench to create load on a remote PostgreSQL database on <a href="https://go.aiven.io/francesco-signup">Aiven</a>.</p>
<h2 id="install-pgbench-locally">Install pgbench locally</h2>
<p>In a Mac, <a href="https://www.postgresql.org/docs/current/pgbench.html">pgbench</a> comes with the default PostgreSQL installation via brew. Therefore to have pgbench all you need is to:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew install postgresql
</span></span></code></pre></div><h2 id="create-a-test-postgresql-environment">Create a test PostgreSQL environment</h2>
<p>While you could create a test PostgreSQL environment locally (the <a href="/posts/1brows">1brc challenge blog post</a> contains all the details), this time we&rsquo;ll create an Aiven for PostgreSQL service in minutes:</p>
<ul>
<li>Navigate to <a href="https://go.aiven.io/francesco-signup">Aiven Console</a></li>
<li>Create an account</li>
<li>Create an Aiven for PostgreSQL service on your favorite cloud provider and region</li>
<li>Select the <code>startup-4</code> plan, it will be sufficient for the test.</li>
</ul>
<h2 id="use-pgbench-to-load-test-the-a-postgresql-database">Use pgbench to load test the a PostgreSQL database</h2>
<p>The Aiven for PostgreSQL database comes with a <code>defaultdb</code> database we can use for our testing.</p>
<h3 id="step-1-initialize-the-database">Step 1: Initialize the database</h3>
<p>All we need is to grab the connection details from the <a href="https://go.aiven.io/francesco-signup">Aiven Console</a> and we are ready to <strong>initialize</strong> the database with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench -h &lt;HOST&gt;       <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -p &lt;PORT&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -U &lt;USER&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -i                  <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -s &lt;SCALEFACTOR&gt;    <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    &lt;DBNAME&gt;
</span></span></code></pre></div><p>Where:</p>
<ul>
<li><code>&lt;HOST&gt;</code> is the database hostname</li>
<li><code>&lt;PORT&gt;</code> is the database port</li>
<li><code>&lt;USER&gt;</code> is the database user</li>
<li><code>&lt;DBNAME&gt;</code> is the database name</li>
<li><code>SCALEFACTOR</code> is the test scale factor, <code>100</code> could be a good place to start. The default is <code>1</code> which will create a <code>16MB</code> database, the <code>100</code> scale will create a <code>1.6GB</code> database.</li>
</ul>
<p>We&rsquo;ll be prompted to write the password, that we can find in the <a href="https://go.aiven.io/francesco-signup">Aiven Console</a>.</p>
<blockquote>
<p>Note: You can automate the flow without the need to include the password by storing it in the <code>PGPASSWORD</code> environment variable with
<code>export PGPASSWORD=&lt;PASSWORD&gt;</code> and then rerun the <code>pgbench</code> command above.</p>
</blockquote>
<p>After this pgbench will execute some work including the following tables:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>       Name       | nr_rows
</span></span><span style="display:flex;"><span>------------------+---------
</span></span><span style="display:flex;"><span> pgbench_accounts | 10000000
</span></span><span style="display:flex;"><span> pgbench_branches |      100
</span></span><span style="display:flex;"><span> pgbench_history  |        0 
</span></span><span style="display:flex;"><span> pgbench_tellers  |     1000
</span></span></code></pre></div><h3 id="step-2-execute-a-first-test-to-set-the-baseline">Step 2: execute a first test to set the baseline</h3>
<p>After creating the dataset, it&rsquo;s time to define the performance baseline (a.k.a how much does my database perform under current conditions). Let&rsquo;s create one with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench  -h &lt;HOST&gt;                  <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -p &lt;PORT&gt;                       <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -U &lt;USER&gt;                       <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -c &lt;NUMBER_OF_CLIENTS&gt;          <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -j &lt;NUMBER_OF_PGBENCH_THREADS&gt;  <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -t &lt;NUMBER_OF_TRANSACTIONS&gt;     <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    &lt;DBNAME&gt;
</span></span></code></pre></div><p>Where:</p>
<ul>
<li><code>&lt;NUMBER_OF_CLIENTS&gt;</code> is the number of clients to connect to PostgreSQL with, a good starting point is <code>20</code></li>
<li><code>&lt;NUMBER_OF_PGBENCH_THREADS&gt;</code> is the number pf pgbench threads to run concurrently</li>
<li><code>&lt;NUMBER_OF_TRANSACTIONS&gt;</code> is the overall number of transactions to execute</li>
</ul>
<p>The following code will execute 1000 transactions using 5 parallel threads and 5 clients</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench  -h &lt;HOST&gt;      <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -p &lt;PORT&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -U &lt;USER&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -c <span style="color:#666">5</span>                <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -j <span style="color:#666">5</span>                <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -t <span style="color:#666">1000</span>             <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    &lt;DBNAME&gt;
</span></span></code></pre></div><p>The result is the following:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>pgbench (16.1, server 16.2)
</span></span><span style="display:flex;"><span>starting vacuum...end.
</span></span><span style="display:flex;"><span>transaction type: &lt;builtin: TPC-B (sort of)&gt;
</span></span><span style="display:flex;"><span>scaling factor: 100
</span></span><span style="display:flex;"><span>query mode: simple
</span></span><span style="display:flex;"><span>number of clients: 5
</span></span><span style="display:flex;"><span>number of threads: 5
</span></span><span style="display:flex;"><span>maximum number of tries: 1
</span></span><span style="display:flex;"><span>number of transactions per client: 1000
</span></span><span style="display:flex;"><span>number of transactions actually processed: 5000/5000
</span></span><span style="display:flex;"><span>number of failed transactions: 0 (0.000%)
</span></span><span style="display:flex;"><span>latency average = 180.179 ms
</span></span><span style="display:flex;"><span>initial connection time = 164.343 ms
</span></span><span style="display:flex;"><span>tps = 27.750256 (without initial connection time)
</span></span></code></pre></div><p>Showcasing that we are generating almost 28 transactions per second (<code>tps</code> in the above one) from my laptop sitting in Verona to a database sitting in Turin!</p>
<h3 id="step-3-change-parameters-and-validate-the-new-performance">Step 3: change parameters and validate the new performance</h3>
<p>What could we change? We could increase the percentage of total RAM dedicated to shared buffers to 60% by going in the <a href="https://go.aiven.io/francesco-signup">Aiven Console</a> selecting the PostgreSQL service, selecting the <strong>Service settings</strong> menu and clicking on the <strong>Configure</strong> button next to the Advanced configuration section.</p>
<p><img src="/images/2024/shared_buffers.png" alt="Shared buffers to 60%"></p>
<p>Now, if we try with the same pgbench command:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench  -h &lt;HOST&gt;      <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -p &lt;PORT&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -U &lt;USER&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -c <span style="color:#666">5</span>                <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -j <span style="color:#666">5</span>                <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -t <span style="color:#666">1000</span>             <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    &lt;DBNAME&gt;
</span></span></code></pre></div><p>We get updated results with <code>36</code> tps.</p>
<h3 id="step-4-define-you-custom-workload-in-a-sql-file">Step 4: define you custom workload in a SQL file</h3>
<p>You can customize the type of queries pgbench will execute based on your workloads. All you need to do is to define a <code>SQL</code> file and call it with pgbench <code>-f</code> flag. Let&rsquo;s create a file named <code>test.sql</code> with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="">\</span><span style="color:#008000;font-weight:bold">set</span><span style="color:#bbb"> </span>r1<span style="color:#bbb"> </span>(random(<span style="color:#666">1</span>,<span style="color:#bbb"> </span><span style="color:#666">2000</span>))<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#008000;font-weight:bold">select</span><span style="color:#bbb"> </span><span style="color:#666">*</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">from</span><span style="color:#bbb"> </span>pgbench_accounts<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">where</span><span style="color:#bbb"> </span>bid<span style="color:#bbb"> </span><span style="color:#666">=</span><span style="color:#bbb"> </span>:r1;<span style="color:#bbb">
</span></span></span></code></pre></div><p>In the above we are setting a <code>r1</code> variable with a random number between <code>1</code> and <code>2000</code> and then use it to query the <code>pgbench_accounts</code> table for rows with <code>bid</code> equal to <code>r1</code>.
We can now execute the custom sql file with:</p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pgbench  -h &lt;HOST&gt;      <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -p &lt;PORT&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -U &lt;USER&gt;           <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -c <span style="color:#666">5</span>                <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -j <span style="color:#666">5</span>                <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -t <span style="color:#666">1000</span>             <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    -f test.sql         <span style="color:#b62;font-weight:bold">\
</span></span></span><span style="display:flex;"><span><span style="color:#b62;font-weight:bold"></span>    &lt;DBNAME&gt;
</span></span></code></pre></div><p>In our example the above produces the following output:</p>
<pre tabindex="0"><code>scaling factor: 1
query mode: simple
number of clients: 5
number of threads: 5
maximum number of tries: 1
number of transactions per client: 100
number of transactions actually processed: 500/500
number of failed transactions: 0 (0.000%)
latency average = 10514.270 ms
initial connection time = 245.617 ms
tps = 0.475544 (without initial connection time)
</code></pre><p>A miserable <code>0.47</code> transactions per second. Can we do better?</p>
<h3 id="step-5-optimize-your-database">Step 5: Optimize your database</h3>
<p>Once you took time to write a custom workload to test with pgbench and got a baseline, it&rsquo;s time to optimize your database. You could do it based on your knowledge and available data but, if you are using Aiven, you can receive automated insights about your PostgreSQL database workload and index and (in the future) SQL optimization suggestions. Check out the video below!</p>

    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
      <iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="allowfullscreen" loading="eager" referrerpolicy="strict-origin-when-cross-origin" src="https://www.youtube.com/embed/_hXGKhbgnos?autoplay=0&amp;controls=1&amp;end=0&amp;loop=0&amp;mute=0&amp;start=0" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" title="YouTube video"></iframe>
    </div>

<blockquote>
<p>For more information, check <a href="https://go.aiven.io/francesco-signup">Aiven</a> and <a href="https://www.eversql.com/?utm_medium=organic&amp;utm_source=ext_blog&amp;utm_content=ftisiotpgbench">EverSQL</a></p>
</blockquote>
<p>In our case, Aiven will suggest to add an index on the <code>bid</code> column.</p>
<p><img src="/images/2024/index_suggestion.png" alt="Suggestion to add an Index"></p>
<div class="highlight"><pre tabindex="0" style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#008000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">INDEX</span><span style="color:#bbb"> </span>pgbench_accounts_idx_bid<span style="color:#bbb"> </span><span style="color:#008000;font-weight:bold">ON</span><span style="color:#bbb"> </span><span style="color:#ba2121">&#34;pgbench_accounts&#34;</span><span style="color:#bbb"> </span>(<span style="color:#ba2121">&#34;bid&#34;</span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>After creating it, and retrying the pgbench command above, the custom workload speed raised from <code>0.45</code> to <code>35</code> transaction per second.</p>
<h2 id="conclusion">Conclusion</h2>
<p>pgbench is a great tool to perform performance checks on your PostgreSQL database and the custom script option provides a way to customize it to match your workloads. Used with Aiven and its AI insights is a great way to test and optimize your database!</p><ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://ftisiot.net/" >
    &copy;  ftisiot ideas about tech, food and life 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
